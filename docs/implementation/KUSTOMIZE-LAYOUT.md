# Kustomize Configuration Layout

**Purpose:** Define the structure and organization of Kubernetes manifests using Kustomize for Kyklos v0.1.

**Last Updated:** 2025-10-29

## Overview

Kyklos uses Kustomize for manifest composition without templating. This document defines the directory structure, base manifests, and overlays for different deployment scenarios.

## Directory Structure

```
/config
├── crd/
│   ├── bases/
│   │   └── kyklos.io_timewindowscalers.yaml    # Generated CRD
│   └── kustomization.yaml
├── rbac/
│   ├── role.yaml                                # Same-namespace permissions
│   ├── clusterrole.yaml                         # Cross-namespace permissions
│   ├── role_binding.yaml                        # Binds role to SA
│   ├── clusterrole_binding.yaml                 # Binds clusterrole to SA
│   ├── service_account.yaml                     # Controller ServiceAccount
│   ├── leader_election_role.yaml                # Leader election RBAC (v0.2+)
│   ├── leader_election_role_binding.yaml        # Leader election binding (v0.2+)
│   └── kustomization.yaml
├── manager/
│   ├── deployment.yaml                          # Controller Deployment
│   ├── service.yaml                             # Metrics service (optional)
│   └── kustomization.yaml
├── samples/
│   ├── basic.yaml                               # Simple 09:00-17:00 window
│   ├── cross-midnight.yaml                      # 22:00-02:00 window
│   ├── with-grace-period.yaml                   # Grace period example
│   ├── with-holidays.yaml                       # Holiday ConfigMap + TWS
│   ├── cross-namespace.yaml                     # Cross-namespace scaling
│   └── paused.yaml                              # Paused TWS example
├── overlays/
│   ├── dev/
│   │   ├── kustomization.yaml                   # Dev environment
│   │   ├── manager_patch.yaml                   # Lower resources, verbose logs
│   │   └── namespace.yaml                       # kyklos-dev namespace
│   ├── staging/
│   │   ├── kustomization.yaml                   # Staging environment
│   │   ├── manager_patch.yaml                   # Production-like resources
│   │   └── namespace.yaml                       # kyklos-staging namespace
│   └── production/
│       ├── kustomization.yaml                   # Production environment
│       ├── manager_patch.yaml                   # Resource limits, HA (v0.2+)
│       ├── namespace.yaml                       # kyklos-system namespace
│       └── pod_security_policy.yaml             # PSP/PSA constraints
└── default/
    └── kustomization.yaml                       # Default overlay (includes everything)
```

---

## Base Manifests

### `/config/crd/bases/kyklos.io_timewindowscalers.yaml`

**Source:** Generated by controller-gen from `/api/v1alpha1/timewindowscaler_types.go`

**Generation Command:**
```bash
make manifests
# Runs: controller-gen crd paths=./api/... output:crd:dir=config/crd/bases
```

**Contents:**
- CustomResourceDefinition for TimeWindowScaler
- OpenAPI validation from kubebuilder markers
- Status subresource enabled
- Printer columns for `kubectl get tws`

**Important Fields:**
```yaml
spec:
  group: kyklos.io
  names:
    kind: TimeWindowScaler
    plural: timewindowscalers
    singular: timewindowscaler
    shortNames: [tws]
  scope: Namespaced
  versions:
  - name: v1alpha1
    schema:
      openAPIV3Schema:
        # Generated from Go struct tags
    served: true
    storage: true
    subresources:
      status: {}
    additionalPrinterColumns:
    - name: Effective Replicas
      type: integer
      jsonPath: .status.effectiveReplicas
    - name: Current Window
      type: string
      jsonPath: .status.currentWindow
    - name: Ready
      type: string
      jsonPath: .status.conditions[?(@.type=="Ready")].status
    - name: Age
      type: date
      jsonPath: .metadata.creationTimestamp
```

**Manual Edits:** None (always regenerate)

---

### `/config/rbac/role.yaml`

**Purpose:** Same-namespace permissions for the controller.

**Source:** Generated from kubebuilder RBAC markers, then manually augmented.

**Contents:**

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: kyklos-controller-role
rules:
# TimeWindowScaler permissions
- apiGroups: ["kyklos.io"]
  resources: ["timewindowscalers"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["kyklos.io"]
  resources: ["timewindowscalers/status"]
  verbs: ["get", "update", "patch"]

# Target workload permissions (same namespace)
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["get", "list", "watch", "update", "patch"]

# ConfigMap permissions (for holiday support)
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "list", "watch"]

# Event permissions
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create", "patch"]
```

**Usage:** Bind to ServiceAccount for same-namespace deployments.

---

### `/config/rbac/clusterrole.yaml`

**Purpose:** Cross-namespace permissions for the controller.

**Source:** Manually created (not generated).

**Contents:**

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: kyklos-controller-clusterrole
rules:
# TimeWindowScaler permissions (all namespaces)
- apiGroups: ["kyklos.io"]
  resources: ["timewindowscalers"]
  verbs: ["get", "list", "watch"]
- apiGroups: ["kyklos.io"]
  resources: ["timewindowscalers/status"]
  verbs: ["get", "update", "patch"]

# Target workload permissions (all namespaces)
- apiGroups: ["apps"]
  resources: ["deployments"]
  verbs: ["get", "list", "watch", "update", "patch"]

# ConfigMap permissions (all namespaces)
- apiGroups: [""]
  resources: ["configmaps"]
  verbs: ["get", "list", "watch"]

# Event permissions (all namespaces)
- apiGroups: [""]
  resources: ["events"]
  verbs: ["create", "patch"]
```

**Security Note:** Use ClusterRole only when cross-namespace scaling is required. Prefer Role for same-namespace deployments.

---

### `/config/rbac/service_account.yaml`

**Purpose:** ServiceAccount for the controller.

**Contents:**

```yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: kyklos-controller
  namespace: kyklos-system
```

**Notes:**
- Namespace is patched by overlays
- No special annotations needed for v0.1
- Future: Workload identity annotations (GKE, EKS, AKS)

---

### `/config/rbac/role_binding.yaml`

**Purpose:** Bind Role to ServiceAccount for same-namespace mode.

**Contents:**

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: kyklos-controller-rolebinding
  namespace: kyklos-system
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: kyklos-controller-role
subjects:
- kind: ServiceAccount
  name: kyklos-controller
  namespace: kyklos-system
```

---

### `/config/rbac/clusterrole_binding.yaml`

**Purpose:** Bind ClusterRole to ServiceAccount for cross-namespace mode.

**Contents:**

```yaml
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kyklos-controller-clusterrolebinding
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kyklos-controller-clusterrole
subjects:
- kind: ServiceAccount
  name: kyklos-controller
  namespace: kyklos-system
```

**Security Note:** Only include in overlay if cross-namespace scaling is needed.

---

### `/config/manager/deployment.yaml`

**Purpose:** Controller Deployment manifest.

**Contents:**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kyklos-controller
  namespace: kyklos-system
  labels:
    app: kyklos-controller
spec:
  replicas: 1  # Single replica in v0.1 (no leader election)
  selector:
    matchLabels:
      app: kyklos-controller
  template:
    metadata:
      labels:
        app: kyklos-controller
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"
    spec:
      serviceAccountName: kyklos-controller
      securityContext:
        runAsNonRoot: true
        runAsUser: 65532
        fsGroup: 65532
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: controller
        image: ghcr.io/aykumar/kyklos-controller:v0.1.0
        imagePullPolicy: IfNotPresent
        command:
        - /controller
        args:
        - --metrics-bind-address=:8080
        - --health-probe-bind-address=:8081
        - --log-level=info
        - --log-format=json
        env:
        - name: POD_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        ports:
        - name: metrics
          containerPort: 8080
          protocol: TCP
        - name: health
          containerPort: 8081
          protocol: TCP
        livenessProbe:
          httpGet:
            path: /healthz
            port: health
          initialDelaySeconds: 15
          periodSeconds: 20
        readinessProbe:
          httpGet:
            path: /readyz
            port: health
          initialDelaySeconds: 5
          periodSeconds: 10
        resources:
          requests:
            cpu: 100m
            memory: 64Mi
          limits:
            cpu: 500m
            memory: 256Mi
        securityContext:
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          runAsNonRoot: true
          capabilities:
            drop:
            - ALL
```

**Patching:** Overlays can patch image, resources, log-level, replicas (v0.2+ with leader election).

---

### `/config/manager/service.yaml`

**Purpose:** Service for metrics endpoint (optional, for Prometheus).

**Contents:**

```yaml
apiVersion: v1
kind: Service
metadata:
  name: kyklos-controller-metrics
  namespace: kyklos-system
  labels:
    app: kyklos-controller
spec:
  selector:
    app: kyklos-controller
  ports:
  - name: metrics
    port: 8080
    targetPort: metrics
    protocol: TCP
  type: ClusterIP
```

**Usage:** Optional, only needed if Prometheus ServiceMonitor is used.

---

## Kustomization Files

### `/config/crd/kustomization.yaml`

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- bases/kyklos.io_timewindowscalers.yaml
```

---

### `/config/rbac/kustomization.yaml`

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- service_account.yaml
- role.yaml
- role_binding.yaml
# Optionally include for cross-namespace:
# - clusterrole.yaml
# - clusterrole_binding.yaml
```

---

### `/config/manager/kustomization.yaml`

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
- deployment.yaml
- service.yaml

images:
- name: ghcr.io/aykumar/kyklos-controller
  newTag: v0.1.0
```

---

### `/config/default/kustomization.yaml`

**Purpose:** Default overlay that includes all base resources.

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: kyklos-system

namePrefix: ""

labels:
- includeSelectors: true
  pairs:
    app.kubernetes.io/name: kyklos
    app.kubernetes.io/component: controller
    app.kubernetes.io/part-of: kyklos
    app.kubernetes.io/managed-by: kustomize

resources:
- ../crd
- ../rbac
- ../manager

# Create namespace if it doesn't exist
namespace: kyklos-system
```

**Usage:**
```bash
kubectl kustomize config/default | kubectl apply -f -
```

---

## Overlays

### Dev Overlay (`/config/overlays/dev`)

**Purpose:** Development environment with verbose logging and lower resources.

**`/config/overlays/dev/kustomization.yaml`:**

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: kyklos-dev

bases:
- ../../default

patchesStrategicMerge:
- manager_patch.yaml
- namespace.yaml

images:
- name: ghcr.io/aykumar/kyklos-controller
  newTag: latest  # Use latest build for dev
```

**`/config/overlays/dev/namespace.yaml`:**

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: kyklos-dev
```

**`/config/overlays/dev/manager_patch.yaml`:**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kyklos-controller
  namespace: kyklos-dev
spec:
  template:
    spec:
      containers:
      - name: controller
        args:
        - --metrics-bind-address=:8080
        - --health-probe-bind-address=:8081
        - --log-level=debug  # Verbose logging for dev
        - --log-format=text  # Human-readable logs
        resources:
          requests:
            cpu: 50m
            memory: 32Mi
          limits:
            cpu: 200m
            memory: 128Mi
```

**Usage:**
```bash
kubectl kustomize config/overlays/dev | kubectl apply -f -
```

---

### Staging Overlay (`/config/overlays/staging`)

**Purpose:** Staging environment with production-like resources but separate namespace.

**`/config/overlays/staging/kustomization.yaml`:**

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: kyklos-staging

bases:
- ../../default

patchesStrategicMerge:
- manager_patch.yaml
- namespace.yaml

images:
- name: ghcr.io/aykumar/kyklos-controller
  newTag: v0.1.0-rc.1  # Release candidate for staging
```

**`/config/overlays/staging/manager_patch.yaml`:**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kyklos-controller
  namespace: kyklos-staging
spec:
  template:
    spec:
      containers:
      - name: controller
        args:
        - --metrics-bind-address=:8080
        - --health-probe-bind-address=:8081
        - --log-level=info
        - --log-format=json
        resources:
          requests:
            cpu: 100m
            memory: 64Mi
          limits:
            cpu: 500m
            memory: 256Mi
```

---

### Production Overlay (`/config/overlays/production`)

**Purpose:** Production environment with strict security and resource limits.

**`/config/overlays/production/kustomization.yaml`:**

```yaml
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: kyklos-system

bases:
- ../../default

patchesStrategicMerge:
- manager_patch.yaml
- namespace.yaml
- pod_security_policy.yaml  # Pod Security Admission labels

images:
- name: ghcr.io/aykumar/kyklos-controller
  newTag: v0.1.0  # Stable release
```

**`/config/overlays/production/namespace.yaml`:**

```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: kyklos-system
  labels:
    pod-security.kubernetes.io/enforce: restricted
    pod-security.kubernetes.io/audit: restricted
    pod-security.kubernetes.io/warn: restricted
```

**`/config/overlays/production/manager_patch.yaml`:**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kyklos-controller
  namespace: kyklos-system
spec:
  replicas: 1  # v0.1: single replica; v0.2: enable leader election and scale to 2+
  template:
    metadata:
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"
    spec:
      containers:
      - name: controller
        args:
        - --metrics-bind-address=:8080
        - --health-probe-bind-address=:8081
        - --log-level=info
        - --log-format=json
        resources:
          requests:
            cpu: 200m
            memory: 128Mi
          limits:
            cpu: 1000m
            memory: 512Mi
```

---

## Sample Resources

### `/config/samples/basic.yaml`

**Purpose:** Simple 09:00-17:00 business hours example.

```yaml
apiVersion: kyklos.io/v1alpha1
kind: TimeWindowScaler
metadata:
  name: webapp-office-hours
  namespace: production
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: webapp
  timezone: "America/New_York"
  defaultReplicas: 2
  windows:
  - days: ["Mon", "Tue", "Wed", "Thu", "Fri"]
    start: "09:00"
    end: "17:00"
    replicas: 10
```

---

### `/config/samples/cross-midnight.yaml`

**Purpose:** Cross-midnight window example (22:00-02:00).

```yaml
apiVersion: kyklos.io/v1alpha1
kind: TimeWindowScaler
metadata:
  name: batch-processor-night-window
  namespace: data
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: batch-processor
  timezone: "UTC"
  defaultReplicas: 1
  windows:
  - days: ["Mon", "Tue", "Wed", "Thu", "Fri"]
    start: "22:00"
    end: "02:00"
    replicas: 5
```

---

### `/config/samples/with-grace-period.yaml`

**Purpose:** Grace period example (5-minute delay before scale-down).

```yaml
apiVersion: kyklos.io/v1alpha1
kind: TimeWindowScaler
metadata:
  name: api-service-with-grace
  namespace: production
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: api-service
  timezone: "Asia/Kolkata"
  defaultReplicas: 3
  gracePeriodSeconds: 300
  windows:
  - days: ["Mon", "Tue", "Wed", "Thu", "Fri"]
    start: "09:00"
    end: "21:00"
    replicas: 15
```

---

### `/config/samples/with-holidays.yaml`

**Purpose:** Holiday ConfigMap + TWS with treat-as-closed mode.

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: company-holidays-2025
  namespace: production
data:
  # ISO date format (YYYY-MM-DD)
  "2025-01-01": "New Year's Day"
  "2025-12-25": "Christmas Day"
  "2025-07-04": "Independence Day"
---
apiVersion: kyklos.io/v1alpha1
kind: TimeWindowScaler
metadata:
  name: webapp-with-holidays
  namespace: production
spec:
  targetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: webapp
  timezone: "America/New_York"
  defaultReplicas: 2
  windows:
  - days: ["Mon", "Tue", "Wed", "Thu", "Fri"]
    start: "09:00"
    end: "17:00"
    replicas: 10
  holidays:
    mode: "treat-as-closed"
    sourceRef:
      name: company-holidays-2025
```

---

## RBAC Differences Between Overlays

| Overlay | RBAC Mode | Permissions | Notes |
|---------|-----------|-------------|-------|
| Dev | Same-namespace | Role + RoleBinding | Controller and targets in same namespace |
| Staging | Same-namespace | Role + RoleBinding | Controller and targets in same namespace |
| Production (default) | Same-namespace | Role + RoleBinding | Controller in kyklos-system, targets in same namespace |
| Production (cross-ns) | Cross-namespace | ClusterRole + ClusterRoleBinding | Controller scales targets in any namespace |

**To enable cross-namespace in production:**

Edit `/config/overlays/production/kustomization.yaml`:

```yaml
bases:
- ../../default

# Uncomment these lines:
patchesStrategicMerge:
- ../../rbac/clusterrole.yaml
- ../../rbac/clusterrole_binding.yaml
```

---

## Build and Deploy Workflows

### Local Development

```bash
# 1. Generate CRD from Go types
make manifests

# 2. Apply to local kind cluster
kubectl kustomize config/overlays/dev | kubectl apply -f -

# 3. Verify installation
kubectl get crd timewindowscalers.kyklos.io
kubectl get deployment -n kyklos-dev
kubectl logs -n kyklos-dev -l app=kyklos-controller
```

### Staging Deployment

```bash
# 1. Build and push staging image
docker build -t ghcr.io/aykumar/kyklos-controller:v0.1.0-rc.1 .
docker push ghcr.io/aykumar/kyklos-controller:v0.1.0-rc.1

# 2. Apply staging overlay
kubectl kustomize config/overlays/staging | kubectl apply -f -

# 3. Verify
kubectl get pods -n kyklos-staging
```

### Production Release

```bash
# 1. Build and push release image
docker build -t ghcr.io/aykumar/kyklos-controller:v0.1.0 .
docker push ghcr.io/aykumar/kyklos-controller:v0.1.0

# 2. Generate all-in-one install YAML
kubectl kustomize config/overlays/production > kyklos-v0.1.0.yaml

# 3. Apply to production cluster
kubectl apply -f kyklos-v0.1.0.yaml

# 4. Verify
kubectl get pods -n kyklos-system
kubectl get crd timewindowscalers.kyklos.io
```

---

## Makefile Targets

Add these targets to `/Makefile`:

```makefile
# Kustomize installation
.PHONY: kustomize
kustomize: ## Install kustomize if not present
	$(call go-install-tool,$(KUSTOMIZE),sigs.k8s.io/kustomize/kustomize/v4@latest)

# Generate and apply manifests
.PHONY: install
install: manifests kustomize ## Install CRDs to cluster
	$(KUSTOMIZE) build config/crd | kubectl apply -f -

.PHONY: uninstall
uninstall: manifests kustomize ## Uninstall CRDs from cluster
	$(KUSTOMIZE) build config/crd | kubectl delete -f -

.PHONY: deploy
deploy: manifests kustomize ## Deploy controller to cluster (default overlay)
	$(KUSTOMIZE) build config/default | kubectl apply -f -

.PHONY: undeploy
undeploy: ## Undeploy controller from cluster
	$(KUSTOMIZE) build config/default | kubectl delete -f -

.PHONY: deploy-dev
deploy-dev: manifests kustomize ## Deploy to dev overlay
	$(KUSTOMIZE) build config/overlays/dev | kubectl apply -f -

.PHONY: deploy-staging
deploy-staging: manifests kustomize ## Deploy to staging overlay
	$(KUSTOMIZE) build config/overlays/staging | kubectl apply -f -

.PHONY: deploy-production
deploy-production: manifests kustomize ## Deploy to production overlay
	$(KUSTOMIZE) build config/overlays/production | kubectl apply -f -

.PHONY: release-bundle
release-bundle: manifests kustomize ## Generate all-in-one install YAML
	$(KUSTOMIZE) build config/overlays/production > kyklos-$(VERSION).yaml
	@echo "Release bundle: kyklos-$(VERSION).yaml"
```

---

## Validation

Before committing Kustomize changes:

```bash
# 1. Validate all overlays build correctly
kubectl kustomize config/default
kubectl kustomize config/overlays/dev
kubectl kustomize config/overlays/staging
kubectl kustomize config/overlays/production

# 2. Dry-run apply to check for errors
kubectl kustomize config/default | kubectl apply --dry-run=client -f -

# 3. Check RBAC permissions
kubectl kustomize config/rbac | kubectl auth reconcile -f -
```

---

## Summary

**Base Manifests:**
- CRD (generated)
- RBAC (Role, ClusterRole, ServiceAccount, Bindings)
- Deployment (controller)
- Service (metrics)

**Overlays:**
- Dev: Verbose logs, low resources, latest image
- Staging: Production-like, RC image
- Production: Strict security, stable image, PSA labels

**RBAC Modes:**
- Same-namespace: Role + RoleBinding (default)
- Cross-namespace: ClusterRole + ClusterRoleBinding (opt-in)

**Sample Resources:**
- basic.yaml
- cross-midnight.yaml
- with-grace-period.yaml
- with-holidays.yaml
- cross-namespace.yaml
- paused.yaml
